name: Branch-Based Approval Workflow

on:
  push:
    branches:
      - 'feature/*'
      - 'hotfix/*'
      - 'main'

jobs:
  trigger-approval:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Approvers Based on Branch
        id: approvers
        run: |
          branch_name=${GITHUB_REF##*/}
          if echo "$branch_name" | grep -qE '^feature/'; then
            echo "hamza.koc@deop.ca" > approvers.txt
          elif echo "$branch_name" | grep -qE '^hotfix/'; then
            echo "hamza.koc@deop.ca" > approvers.txt
          elif [[ "$branch_name" == "main" ]]; then
            echo "hamza.koc@deop.ca" > approvers.txt
          else
            echo "hamza.koc@deop.ca" > approvers.txt
          fi
          approvers=$(cat approvers.txt)
          echo "approvers=$approvers" >> $GITHUB_ENV
      
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: "noreply@example.com"
          password: "dummy-password"
          subject: "Approval Needed for Branch: ${GITHUB_REF##*/}"
          body: "Approval is required for branch: ${GITHUB_REF##*/}. Approvers: ${{ env.approvers }}"
          to: ${{ env.approvers }}
          from: "GitHub Actions <noreply@example.com>"

      - name: Post-Approval Actions
        run: |
          echo "Approval completed for branch: ${GITHUB_REF##*/}"
